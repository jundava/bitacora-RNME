<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bit√°cora Gesti√≥n del RNME - ANTSV</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>

  <style>
    :root {
      --antsv-dark: #243F5C;
      --antsv-green: #84B74C;
      --antsv-light: #E4EEF4;
      --antsv-white: #FFFFFF;
    }

    [v-cloak] { display: none; }
    
    body { 
      background-color: var(--antsv-light); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      color: var(--antsv-dark);
      overflow-x: hidden;
    }

    .btn-primary { background-color: var(--antsv-green); border-color: var(--antsv-green); color: var(--antsv-white); }
    .btn-primary:hover { background-color: #72a33c; border-color: #72a33c; }
    .btn-outline-primary { color: var(--antsv-dark); border-color: var(--antsv-dark); }
    .btn-outline-primary:hover { background-color: var(--antsv-dark); color: var(--antsv-white); }
    .text-primary { color: var(--antsv-dark) !important; }
    
    .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(36, 63, 92, 0.08); background-color: var(--antsv-white); }
    .card-header { background-color: var(--antsv-dark); color: var(--antsv-white); border-radius: 10px 10px 0 0 !important; border-bottom: none;}
    .table-light { background-color: var(--antsv-light); color: var(--antsv-dark); }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(228, 238, 244, 0.95); z-index: 1060; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    .drag-drop-zone { border: 2px dashed var(--antsv-green); border-radius: 8px; padding: 2.5rem 1rem; text-align: center; background-color: rgba(132, 183, 76, 0.05); cursor: pointer; transition: 0.3s; }
    .drag-drop-zone:hover { background-color: rgba(132, 183, 76, 0.15); }
    .drag-drop-zone i { color: var(--antsv-green); transition: 0.3s; }
    .drag-drop-zone:hover i { transform: translateY(-5px); }

    .wrapper { display: flex; width: 100%; align-items: stretch; }
    
    #sidebar {
      min-width: 250px;
      max-width: 250px;
      background: var(--antsv-dark);
      color: var(--antsv-white);
      transition: all 0.3s;
      min-height: 100vh;
      position: fixed;
      z-index: 1040;
    }
    
    #sidebar .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    #sidebar .sidebar-header img { max-width: 120px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    
    #sidebar ul p { color: var(--antsv-white); padding: 10px; }
    #sidebar ul li a { padding: 15px 20px; font-size: 1.1em; display: block; color: var(--antsv-light); text-decoration: none; border-left: 4px solid transparent; transition: 0.2s;}
    #sidebar ul li a:hover, #sidebar ul li a.active-link { background: rgba(255,255,255,0.05); color: var(--antsv-white); border-left: 4px solid var(--antsv-green); }
    #sidebar ul li a i { font-size: 1.2rem; width: 30px; display: inline-block; text-align: center; }
    
    #content {
      width: 100%;
      padding: 0;
      min-height: 100vh;
      transition: all 0.3s;
      margin-left: 250px;
    }

    .top-navbar { background-color: var(--antsv-white); padding: 15px 25px; box-shadow: 0 2px 4px rgba(36, 63, 92, 0.05); display: flex; justify-content: space-between; align-items: center; }

    @media (max-width: 768px) {
      #sidebar { margin-left: -250px; }
      #sidebar.active { margin-left: 0; }
      #content { margin-left: 0; }
      .overlay-mobile { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1030; display: none; }
      .overlay-mobile.active { display: block; }
    }
  </style>
</head>
<body>

  <div id="app" v-cloak>
    <div v-if="isLoading" class="loading-overlay">
      <div class="spinner-border" style="width: 4rem; height: 4rem; color: var(--antsv-dark);" role="status"></div>
      <h4 class="mt-4" style="color: var(--antsv-dark); font-weight: bold;">{{ loadingMessage }}</h4>
    </div>

    <div v-else-if="config.MODO_MANTENIMIENTO === 'True' && role !== 'ADMIN'" class="container text-center mt-5">
      <img :src="logoANTSV" alt="ANTSV" style="max-width: 200px;" class="mb-4">
      <h1 style="color: var(--antsv-dark);"><i class="bi bi-tools me-2"></i>Sistema en Mantenimiento</h1>
      <p class="lead">La app Gesti√≥n del RNME est√° bajo actualizaci√≥n. Contacte a <strong style="color: var(--antsv-green);">{{ config.EMAIL_SOPORTE_TECNICO }}</strong>.</p>
    </div>

    <div class="wrapper" v-else>

    <nav id="sidebar" :class="{ 'active': isMobileMenuOpen }" v-if="role !== 'PUBLIC'">
        <div class="sidebar-header">
          <img v-if="logoANTSV" :src="logoANTSV" alt="Logo RNME">
          <div v-else class="text-white fs-1"><i class="bi bi-image"></i></div>
          <h6 class="mt-2 text fw-bold" style="color: var(--antsv-green);">Gesti√≥n del RNME</h6>
          <span class="badge" style="background-color: var(--antsv-green);"><i class="bi bi-person-badge me-1"></i>{{ role }}</span>
        </div>

        <ul class="list-unstyled components mt-3">
          <li><a href="#" :class="{'active-link': currentView === 'DASHBOARD'}" @click.prevent="navigate('DASHBOARD')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
          <li v-if="tienePermiso('Empresas')"><a href="#" :class="{'active-link': currentView === 'EMPRESAS'}" @click.prevent="navigate('EMPRESAS')"><i class="bi bi-buildings"></i> Empresas</a></li>
          <li v-if="tienePermiso('Equipos')"><a href="#" :class="{'active-link': currentView === 'EQUIPOS'}" @click.prevent="navigate('EQUIPOS')"><i class="bi bi-pc-display"></i> Equipos</a></li>
          <li v-if="tienePermiso('Ubicaciones')"><a href="#" :class="{'active-link': currentView === 'UBICACIONES'}" @click.prevent="navigate('UBICACIONES')"><i class="bi bi-geo-alt"></i> Ubicaciones</a></li>
          <li v-if="tienePermiso('Resoluciones')"><a href="#" :class="{'active-link': currentView === 'RESOLUCIONES'}" @click.prevent="navigate('RESOLUCIONES')"><i class="bi bi-file-earmark-medical"></i> Resoluciones</a></li>
          <li v-if="tienePermiso('Configuracion') || role === 'ADMIN'"><a href="#" :class="{'active-link': currentView === 'CONFIGURACION'}" @click.prevent="navigate('CONFIGURACION')"><i class="bi bi-gear"></i> Configuraci√≥n</a></li>
        </ul>
      </nav>

      <div class="overlay-mobile" :class="{ 'active': isMobileMenuOpen }" @click="isMobileMenuOpen = false"></div>

      <div id="content" :style="role === 'PUBLIC' ? 'margin-left: 0;' : ''">

        <div class="top-navbar mb-4">
          <div class="d-flex align-items-center">
            <button type="button" class="btn btn-outline-primary d-md-none me-3" @click="isMobileMenuOpen = !isMobileMenuOpen" v-if="role !== 'PUBLIC'"><i class="bi bi-list fs-4"></i></button>

            <div v-if="role === 'PUBLIC'" class="d-flex align-items-center">
              <img v-if="logoANTSV" :src="logoANTSV" alt="ANTSV" style="height: 40px;" class="me-2">
              <h4 class="mb-0 fw-bold" style="color: var(--antsv-dark);">Gesti√≥n del RNME</h4>
            </div>
            <h5 class="mb-0 fw-bold d-none d-md-block" style="color: var(--antsv-dark);" v-else>
              {{ currentView === 'DASHBOARD' ? 'Dashboard' : currentView }}
            </h5>
          </div>

          <div class="d-flex align-items-center">
            <div v-if="isRefreshing" class="spinner-border spinner-border-sm me-3" style="color: var(--antsv-green);" role="status" title="Sincronizando datos..."></div>

            <img v-if="db.usuarios && db.usuarios.find(u => u.email === currentUser)?.avatar"
                 :src="db.usuarios.find(u => u.email === currentUser).avatar" class="rounded-circle border me-2 shadow-sm"
                 style="width: 32px; height: 32px; object-fit: cover;">
            <i v-else class="bi bi-person-circle fs-4 me-2 text-muted"></i>

            <small class="text-muted fw-bold">{{ currentUser }}</small>
          </div>
        </div>

        <div class="container-fluid px-4 pb-5">

          <div v-if="role === 'PUBLIC'" class="row mb-4 mt-5">
            <div class="col-md-6 mx-auto text-center">
              <i class="bi bi-shield-lock-fill text-danger mb-3" style="font-size: 5rem;"></i>
              <h2 style="color: var(--antsv-dark); font-weight: bold;">Acceso Restringido</h2>
              <p class="text-muted fs-5 mt-3">Este portal es de uso exclusivo para la administraci√≥n interna de la ANTSV.</p>
              <p class="text-muted">Si busca consultar la validez de un equipo, por favor dir√≠jase al Verificador P√∫blico.</p>
            </div>
          </div>

          <div v-if="currentView === 'EMPRESAS'" class="card shadow-sm border-0">
            <div class="card-header d-flex justify-content-between align-items-center p-3">
              <h5 class="mb-0"><i class="bi bi-journal-bookmark me-2"></i>Directorio de Empresas</h5>
              <button class="btn btn-primary btn-sm" @click="openEmpresaForm()" v-if="!showEmpresaForm && esEditor('Empresas')">
                <i class="bi bi-plus-circle me-1"></i> Nueva Empresa
              </button>
            </div>
            <div class="card-body">
              <div v-if="showEmpresaForm" class="p-4 rounded mb-4" style="background-color: rgba(36, 63, 92, 0.03); border: 1px solid rgba(36, 63, 92, 0.1);">
                <h5 class="mb-3" style="color: var(--antsv-green); font-weight: bold;"><i :class="isEditingEmp ? 'bi bi-pencil-square' : 'bi bi-building-add'" class="me-2"></i>{{ isEditingEmp ? 'Editar Empresa' : 'Registrar Nueva Empresa' }}</h5>
                <div class="row g-3">
                  <div class="col-md-2"><label class="form-label fw-bold">ID / Siglas <span class="text-danger">*</span></label><input type="text" class="form-control text-uppercase" v-model="formEmp.id_empresa" :disabled="isEditingEmp" placeholder="Ej: TAC" maxlength="5"></div>
                  <div class="col-md-5"><label class="form-label fw-bold">Raz√≥n Social <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formEmp.razon_social"></div>
                  <div class="col-md-5"><label class="form-label fw-bold">RUC <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formEmp.ruc"></div>
                  <div class="col-md-4"><label class="form-label text-muted">Representante Legal</label><input type="text" class="form-control" v-model="formEmp.representante"></div>
                  <div class="col-md-4"><label class="form-label text-muted">Email Institucional</label><input type="email" class="form-control" v-model="formEmp.email"></div>
                  <div class="col-md-4">
                    <label class="form-label text-muted">Tipo de Entidad</label>
                    <select class="form-select" v-model="formEmp.tipo_entidad">
                      <option value="Prestadores de Servicios M√©dicos">Prestadores de Servicios M√©dicos</option>
                      <option value="Fabricante de Equipos">Fabricante de Equipos</option>
                      <option value="Importadores">Importadores</option>
                      <option value="Estado/P√∫blico">Estado/P√∫blico</option>
                    </select>
                  </div>
                  <div class="col-md-6"><label class="form-label text-muted">Direcci√≥n</label><input type="text" class="form-control" v-model="formEmp.direccion"></div>
                  <div class="col-md-6"><label class="form-label text-muted">Actividad Principal</label><input type="text" class="form-control" v-model="formEmp.actividad_principal"></div>
                </div>
                <div class="mt-4 text-end">
                  <button class="btn btn-outline-secondary me-2" @click="showEmpresaForm = false"><i class="bi bi-x-circle me-1"></i>Cancelar</button>
                  <button class="btn btn-primary" @click="submitEmpresa" :disabled="!isFormEmpValid"><i class="bi bi-floppy me-1"></i> Guardar Empresa</button>
                </div>
              </div>

              <div class="table-responsive" v-show="!showEmpresaForm">
                <table class="table table-hover table-bordered align-middle">
                  <thead class="table-light text-center">
                    <tr>
                      <th>ID</th>
                      <th>Raz√≥n Social</th>
                      <th>RUC</th>
                      <th>Email</th>
                      <th>Tipo Entidad</th>
                      <th v-if="esEditor('Empresas')">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="emp in db.empresas" :key="emp.id_empresa">
                      <td class="text-center fw-bold" style="color: var(--antsv-dark);">{{ emp.id_empresa }}</td>
                      <td>{{ emp.razon_social }}</td>
                      <td class="text-center">{{ emp.ruc }}</td>
                      <td><i class="bi bi-envelope me-1 text-muted" v-if="emp.email"></i>{{ emp.email }}</td>
                      <td><span class="badge" style="background-color: var(--antsv-dark); color: var(--antsv-white);">{{ emp.tipo_entidad }}</span></td>
                      
                      <td class="text-center" v-if="esEditor('Empresas')">
                        <button class="btn btn-sm btn-outline-primary me-1" @click="openEmpresaForm(emp)" title="Editar"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteEmpresa(emp.id_empresa, emp.razon_social)" title="Eliminar"><i class="bi bi-trash3"></i></button>
                      </td>
                    </tr>
                    
                    <tr v-if="db.empresas.length === 0">
                      <td :colspan="esEditor('Empresas') ? 6 : 5" class="text-center text-muted">
                        <i class="bi bi-info-circle me-1"></i>No hay empresas registradas.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div v-if="currentView === 'RESOLUCIONES'" class="card shadow-sm border-0">
            <div class="card-header p-0" style="background-color: var(--antsv-dark); border-radius: 10px 10px 0 0;">
              <ul class="nav nav-tabs px-3 pt-3" style="border-bottom: none;">
                <li class="nav-item">
                  <a class="nav-link rounded-top" :class="{active: activeResTab === 'LISTADO', 'text-dark': activeResTab === 'LISTADO', 'text-white': activeResTab !== 'LISTADO'}" href="#" @click.prevent="activeResTab = 'LISTADO'" style="border: none; border-bottom: 3px solid transparent;" :style="activeResTab === 'LISTADO' ? 'background-color: var(--antsv-white); font-weight: bold;' : ''"><i class="bi bi-list-ul me-1"></i> Listado de Resoluciones</a>
                </li>
                
                <li class="nav-item" v-if="esEditor('Resoluciones')">
                  <a class="nav-link rounded-top" :class="{active: activeResTab === 'NUEVA', 'text-dark': activeResTab === 'NUEVA', 'text-white': activeResTab !== 'NUEVA'}" href="#" @click.prevent="activeResTab = 'NUEVA'" style="border: none; border-bottom: 3px solid transparent;" :style="activeResTab === 'NUEVA' ? 'background-color: var(--antsv-white); font-weight: bold;' : ''"><i class="bi bi-cloud-arrow-up me-1"></i> Subir Nueva</a>
                </li>
              </ul>
            </div>
            
            <div class="card-body">
              <div v-show="activeResTab === 'LISTADO'">
                <div class="row g-2 mb-3 p-3 rounded" style="background-color: var(--antsv-light); border: 1px solid rgba(36, 63, 92, 0.1);">
                  <div class="col-md-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                      <input type="text" class="form-control" v-model="searchRes" placeholder="Buscar Resoluci√≥n o Equipo...">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" v-model="filterTipoActoRes">
                      <option value="">üìÑ Todos los Tipos de Acto</option>
                      <option value="1-Homologaci√≥n">1-Homologaci√≥n Inicial</option>
                      <option value="2-Renovaci√≥n">2-Renovaci√≥n</option>
                      <option value="3-Cambio Ubicaci√≥n">3-Cambio Ubicaci√≥n</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" v-model="filterEstadoRes">
                      <option value="">üü¢/üî¥ Todos los Estados</option>
                      <option v-for="est in estadosResolucionList" :key="est.id_catalogo" :value="est.valor">{{ est.valor }}</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle border shadow-sm">
                    <thead class="table-light">
                      <tr>
                        <th>Nro. Resoluci√≥n</th>
                        <th>Equipo Afectado</th>
                        <th>Tipo de Acto</th>
                        <th>Periodo Vigencia</th>
                        <th>Estado</th>
                        <th class="text-center">Documento</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="res in filteredResoluciones" :key="res.id_resolucion">
                        <td class="fw-bold" style="color: var(--antsv-dark);">{{ res.id_resolucion }}</td>
                        <td>
                          <div v-for="(eqId, index) in res.equipos" :key="eqId" :class="{'mb-2 pb-2 border-bottom': index < res.equipos.length - 1}">
                            <div class="fw-bold"><i class="bi bi-cpu me-1 text-muted"></i>{{ eqId }}</div>
                            <div class="small text-muted mb-1">{{ getEquipoMarca(eqId) }}</div>
                            <div class="small" style="color: var(--antsv-green); font-size: 0.75rem;"><i class="bi bi-geo-alt-fill me-1"></i>{{ getEquipoUbicacion(eqId) }}</div>
                          </div>
                        </td>
                        <td>
                          <span class="badge border" :class="{'bg-primary bg-opacity-10 text-primary border-primary': res.tipo_acto === '1-Homologaci√≥n', 'bg-success bg-opacity-10 text-success border-success': res.tipo_acto === '2-Renovaci√≥n', 'bg-warning bg-opacity-10 text-dark border-warning': res.tipo_acto === '3-Cambio Ubicaci√≥n'}">
                            <i class="me-1" :class="{'bi-award-fill': res.tipo_acto === '1-Homologaci√≥n', 'bi-arrow-repeat': res.tipo_acto === '2-Renovaci√≥n', 'bi-truck': res.tipo_acto === '3-Cambio Ubicaci√≥n'}"></i>{{ res.tipo_acto }}
                          </span>
                        </td>
                        <td>
                          <div class="small">
                            <div><span class="text-muted fw-bold">Emisi√≥n:</span> {{ res.fecha_emision }}</div>
                            <div><span class="text-muted fw-bold">Vencimiento:</span> <span :class="{'text-danger fw-bold': res?.estado === 'No Vigente'}">{{ res.vencimiento }}</span></div>
                          </div>
                        </td>
                        <td>
                          <span class="badge" :class="res?.estado === 'Vigente' ? 'bg-success' : 'bg-danger'"><i :class="res?.estado === 'Vigente' ? 'bi bi-check-circle' : 'bi bi-x-circle'" class="me-1"></i>{{ res?.estado || 'Desconocido' }}</span>
                        </td>
                        <td class="text-center">
                          <button v-if="esEditor('Resoluciones')" class="btn btn-sm btn-outline-primary ms-1" @click="openEditRes(res)" title="Editar Resoluci√≥n"><i class="bi bi-pencil-square"></i></button>
                          
                          <a v-if="res.url_drive" :href="res.url_drive" target="_blank" class="btn btn-sm btn-outline-danger ms-1" title="Ver PDF"><i class="bi bi-file-earmark-pdf-fill"></i></a>
                          <span v-if="!res.url_drive" class="text-muted small ms-1"><i class="bi bi-dash"></i></span>
                        </td>
                      </tr>
                      <tr v-if="filteredResoluciones.length === 0">
                        <td colspan="6" class="text-center p-5 text-muted"><i class="bi bi-search display-6 d-block mb-3 opacity-50"></i>No se encontraron resoluciones.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div v-show="activeResTab === 'NUEVA'" class="p-4 rounded shadow-sm" style="background-color: rgba(36, 63, 92, 0.03); border: 1px solid var(--antsv-light);">
                
                <div class="alert alert-warning border-warning d-flex align-items-center mb-4 shadow-sm">
                  <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                  <div>
                    <strong class="d-block">Importante antes de continuar:</strong>
                    Aseg√∫rese de haber registrado previamente los <strong>Equipos</strong> en el m√≥dulo correspondiente. No podr√° vincular resoluciones a equipos que no existan en la base de datos.
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4 pb-2" style="border-bottom: 2px solid var(--antsv-green);">
                  <h5 class="mb-0 fw-bold" style="color: var(--antsv-green);"><i :class="isEditingRes ? 'bi bi-pencil-square' : 'bi bi-file-earmark-plus'" class="me-1"></i> {{ isEditingRes ? 'Editar Resoluci√≥n: ' + formRes.id_original : 'Registrar Nuevo Documento Legal' }}</h5>
                  <button v-if="isEditingRes" class="btn btn-sm btn-outline-secondary" @click="isEditingRes = false; activeResTab = 'LISTADO'"><i class="bi bi-x-circle me-1"></i>Cancelar Edici√≥n</button>
                </div>

                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="mb-4">
                      <label class="form-label fw-bold text-primary"><i class="bi bi-bookmark-star me-2"></i>1. Tipo de Acto</label>
                      <select class="form-select shadow-sm border-primary" v-model="formRes.tipo_acto">
                        <option value="1-Homologaci√≥n">1-Homologaci√≥n Inicial</option>
                        <option value="2-Renovaci√≥n">2-Renovaci√≥n</option>
                        <option value="3-Cambio Ubicaci√≥n">3-Cambio Ubicaci√≥n</option>
                      </select>
                    </div>

                    <div class="mb-4">
                      <label class="form-label fw-bold"><i class="bi bi-hash me-2"></i>2. N√∫mero de Resoluci√≥n</label>
                      <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white">ANTSV N¬∞</span>
                        <input type="number" class="form-control" v-model="formRes.numero" placeholder="Ej: 639">
                        <span class="input-group-text bg-light">/</span>
                        <input type="number" class="form-control" v-model="formRes.anio" placeholder="2026">
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label fw-bold"><i class="bi bi-calendar-event me-2"></i>3. Fechas de Vigencia</label>
                      <div class="row g-2">
                        <div class="col-6">
                          <small class="text-muted d-block mb-1">Fecha Resoluci√≥n</small>
                          <input type="date" class="form-control shadow-sm" v-model="formRes.fecha_emision">
                        </div>
                        <div class="col-6">
                          <small class="text-muted d-block mb-1">Vencimiento (1 a√±o)</small>
                          <input type="date" class="form-control shadow-sm bg-light" v-model="formRes.vencimiento">
                        </div>
                      </div>
                    </div>

                    <div class="mb-4 p-3 rounded bg-warning bg-opacity-10 border border-warning" v-if="formRes.tipo_acto !== '1-Homologaci√≥n'">
                      <label class="form-label fw-bold text-dark"><i class="bi bi-link-45deg me-2 text-warning"></i>4. Resoluci√≥n Anterior (Vinculada)</label>
                      <select class="form-select shadow-sm border-warning" v-model="formRes.afecta">
                        <option value="" disabled>Seleccione resoluci√≥n madre...</option>
                        <option v-for="rm in resolucionesMadreList" :key="rm.id_resolucion" :value="rm.id_resolucion">
                          {{ rm.id_resolucion }} ({{ rm.estado }})
                        </option>
                      </select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-4">
                      <label class="form-label fw-bold"><i class="bi bi-pc-display me-2"></i>5. Equipos Afectados</label>
                      <div class="border rounded p-3 bg-white shadow-sm" style="max-height: 200px; overflow-y: auto;">
                        <div class="form-check mb-2" v-for="eq in db.equipos" :key="eq.id_registro">
                          <input class="form-check-input" type="checkbox" :value="eq.id_registro" v-model="formRes.id_equipo" :id="'chk_'+eq.id_registro">
                          <label class="form-check-label w-100" :for="'chk_'+eq.id_registro" style="cursor: pointer;">
                            <span class="fw-bold">{{ eq.id_registro }}</span> - {{ eq.marca }}
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label fw-bold"><i class="bi bi-file-earmark-pdf me-2"></i>6. Documento Escaneado (PDF)</label>
                      <div class="drag-drop-zone shadow-sm" @click="triggerFileInput">
                        <div v-if="!formRes.fileName"><i class="bi bi-cloud-arrow-up display-6"></i><p class="mt-2 mb-0">Seleccionar PDF</p></div>
                        <div v-else class="text-success"><i class="bi bi-check-circle-fill display-6"></i><p class="mt-2 mb-0 fw-bold">{{ formRes.fileName }}</p></div>
                      </div>
                      <input type="file" id="pdfUploader" accept="application/pdf" style="display: none;" @change="handleFileUpload">
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="card border-primary shadow-sm">
                      <div class="card-header bg-primary bg-opacity-10 py-2">
                        <div class="form-check form-switch mb-0">
                          <input class="form-check-input" type="checkbox" id="switchUbis" v-model="formRes.incluir_ubicaciones">
                          <label class="form-check-label fw-bold text-dark" for="switchUbis" style="cursor:pointer;">
                            <i class="bi bi-geo-alt-fill me-1 text-primary"></i> 7. Asignar / Actualizar Ubicaciones F√≠sicas
                          </label>
                        </div>
                      </div>
                      
                      <div class="card-body bg-light" v-if="formRes.incluir_ubicaciones && formRes.id_equipo.length > 0">
                        <div class="alert alert-info py-2 small mb-3">
                          <i class="bi bi-info-circle me-1"></i> Defina el destino de los equipos seleccionados:
                        </div>

                        <div v-for="eqId in formRes.id_equipo" :key="eqId" class="border rounded p-3 mb-3 bg-white shadow-sm" style="border-left: 5px solid var(--antsv-green) !important;">
                          <div class="fw-bold mb-2 text-dark">
                            <i class="bi bi-cpu me-1"></i> Destino para: <span class="badge bg-dark">{{ eqId }}</span> - {{ getEquipoMarca(eqId) }}
                          </div>
                          
                          <div class="row g-2">
                            <div class="col-md-4">
                              <label class="small fw-bold text-muted">Departamento *</label>
                              <select class="form-select form-select-sm shadow-sm" v-model="formRes.ubicaciones_equipos[eqId].departamento">
                                <option value="">Seleccione...</option>
                                <option v-for="d in deptosList" :key="d.valor" :value="d.valor">{{ d.valor }}</option>
                              </select>
                            </div>
                            <div class="col-md-4">
                              <label class="small fw-bold text-muted">Distrito *</label>
                              <select class="form-select form-select-sm shadow-sm" v-model="formRes.ubicaciones_equipos[eqId].distrito" :disabled="!formRes.ubicaciones_equipos[eqId].departamento">
                                <option value="">Seleccione...</option>
                                <option v-for="dis in getDistritosPorDepto(formRes.ubicaciones_equipos[eqId].departamento)" :key="dis.valor" :value="dis.valor">{{ dis.valor }}</option>
                              </select>
                            </div>
                            <div class="col-md-4">
                              <label class="small fw-bold text-muted">Direcci√≥n / Lugar Espec√≠fico *</label>
                              <input type="text" class="form-control form-control-sm shadow-sm" v-model="formRes.ubicaciones_equipos[eqId].lugar_especifico" placeholder="Ej: Cl√≠nica Central...">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="card-body text-center py-4 text-muted" v-else-if="formRes.incluir_ubicaciones && formRes.id_equipo.length === 0">
                        <i class="bi bi-arrow-up-circle fs-2 d-block mb-2 opacity-50"></i>
                        Debe seleccionar al menos un <strong>Equipo Afectado</strong> (Punto 5) para asignar ubicaciones.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-grid mt-5">
                  <button class="btn btn-primary btn-lg shadow" @click="submitResolucion" :disabled="!isFormResValid">
                    <i class="bi bi-save me-2"></i>Registrar Resoluci√≥n y Actualizar Vigencias
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div v-if="currentView === 'EQUIPOS'" class="card shadow-sm border-0">
            <div class="card-header d-flex justify-content-between align-items-center p-3">
              <h5 class="mb-0"><i class="bi bi-pc-display me-2"></i>Gesti√≥n de Equipos Psicof√≠sicos</h5>
              <button class="btn btn-primary btn-sm" @click="openEquipoForm()" v-if="!showEquipoForm && esEditor('Equipos')">
                <i class="bi bi-plus-circle me-1"></i> Registrar Equipo
              </button>
            </div>
            <div class="card-body">
              <div v-if="showEquipoForm" class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-dark text-white py-3"><h5 class="mb-0 fw-bold"><i :class="isEditingEq ? 'bi bi-pencil-square' : 'bi bi-plus-circle'" class="me-2"></i>{{ isEditingEq ? 'Editar Equipo: ' + formEq.id_registro : 'Registrar Nuevo Equipo' }}</h5></div>
                <div class="card-body p-4">
                  <form @submit.prevent="submitEquipo">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <h6 class="fw-bold text-muted mb-3 pb-2 border-bottom"><i class="bi bi-card-heading me-1"></i> Identificaci√≥n y Propiedad</h6>
                        <div class="mb-3" v-if="isEditingEq"><label class="form-label fw-bold"><i class="bi bi-upc-scan me-1 text-primary"></i>ID Registro</label><input type="text" class="form-control form-control-lg fw-bold text-uppercase font-monospace bg-light" v-model="formEq.id_registro" disabled></div>
                        <div class="alert alert-info py-2" v-else><i class="bi bi-info-circle-fill me-2"></i>El ID de Registro se generar√° autom√°ticamente al guardar.</div>
                        <div class="mb-3">
                          <label class="form-label fw-bold"><i class="bi bi-building me-1 text-primary"></i>Empresa Propietaria <span class="text-danger">*</span></label>
                          <select class="form-select form-select-lg" v-model="formEq.id_empresa">
                            <option value="" disabled>Seleccione una Empresa...</option>
                            <option v-for="emp in db.empresas" :key="emp.id_empresa" :value="emp.id_empresa">{{ emp.razon_social }}</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <h6 class="fw-bold text-muted mb-3 pb-2 border-bottom"><i class="bi bi-tools me-1"></i> Detalles T√©cnicos y Estado</h6>
                        <div class="mb-3"><label class="form-label fw-bold"><i class="bi bi-tag me-1 text-primary"></i>Marca del Equipo <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formEq.marca" placeholder="Ej: Norklan, Smartest..."></div>
                        <div class="row g-2 mb-3">
                          <div class="col-6"><label class="form-label fw-bold small"><i class="bi bi-barcode me-1"></i>S. Psicom√©trico <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" v-model="formEq.serial_psicometrico" placeholder="Ej: PYV..."></div>
                          <div class="col-6"><label class="form-label fw-bold small"><i class="bi bi-barcode me-1"></i>S. Sensom√©trico <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" v-model="formEq.serial_sensometrico" placeholder="Ej: PYG..."></div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-stoplights me-1 text-primary"></i>Estado</span>
                            <span v-if="formEq.estado_homologacion" class="badge rounded-pill" :class="{'bg-success': formEq.estado_homologacion === 'Homologado', 'bg-danger': formEq.estado_homologacion === 'No Homologado'}">{{ formEq.estado_homologacion }}</span>
                            <span v-else class="badge rounded-pill bg-secondary"><i class="bi bi-hourglass-split me-1"></i>Sin Homologar</span>
                          </label>
                          <select class="form-select bg-light" v-model="formEq.estado_homologacion" disabled>
                            <option value="">En Blanco / Pendiente</option>
                            <option v-for="est in estadosEquipoList" :key="est.id_catalogo" :value="est.valor">{{ est.valor }}</option>
                          </select>
                          <div class="form-text small text-muted"><i class="bi bi-shield-lock me-1"></i>Este estado se automatiza al subir una Resoluci√≥n.</div>
                        </div>
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-bold"><i class="bi bi-chat-left-text me-1 text-primary"></i>Observaciones / Notas Adicionales</label>
                        <textarea class="form-control" v-model="formEq.descripcion" rows="3" placeholder="Ingrese cualquier nota relevante sobre el equipo, su estado o historial..."></textarea>
                      </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                      <button type="button" class="btn btn-outline-secondary px-4" @click="showEquipoForm = false"><i class="bi bi-x-lg me-2"></i>Cancelar</button>
                      <button type="submit" class="btn btn-success px-4 fw-bold" :disabled="!isFormEqValid"><i class="bi bi-check-lg me-2"></i>{{ isEditingEq ? 'Actualizar Equipo' : 'Guardar Nuevo Equipo' }}</button>
                    </div>
                  </form>
                </div>
              </div>

              <div v-show="!showEquipoForm">
                <div class="row g-2 mb-3 p-3 rounded" style="background-color: var(--antsv-light); border: 1px solid rgba(36, 63, 92, 0.1);">
                  <div class="col-md-4"><div class="input-group input-group-sm"><span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span><input type="text" class="form-control" v-model="searchEq" placeholder="Buscar ID, Marca o Seriales..."></div></div>
                  <div class="col-md-4"><select class="form-select form-select-sm" v-model="filterEmpresaEq"><option value="">üè¢ Todas las Empresas</option><option v-for="emp in db.empresas" :key="emp.id_empresa" :value="emp.id_empresa">{{ emp.razon_social }}</option></select></div>
                  <div class="col-md-4"><select class="form-select form-select-sm" v-model="filterEstadoEq"><option value="">üü¢/üî¥ Todos los Estados</option><option v-for="est in estadosEquipoList" :key="est.id_catalogo" :value="est.valor">{{ est.valor }}</option></select></div>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover table-bordered align-middle shadow-sm">
                    <thead class="table-light text-center">
                      <tr>
                        <th>ID Registro</th>
                        <th>Marca</th>
                        <th>Propietario</th>
                        <th>Componentes</th>
                        <th>Estado</th>
                        <th v-if="esEditor('Equipos')">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="eq in filteredEquipos" :key="eq.id_registro">
                        <td class="text-center fw-bold" style="color: var(--antsv-dark);">{{ eq.id_registro }}</td>
                        <td class="text-center">{{ eq.marca }}</td>
                        <td>{{ getEmpresaNombre(eq.id_empresa) }}</td>
                        <td class="align-middle text-nowrap">
                          <div class="small text-start">
                            <div class="mb-1"><span class="fw-bold" style="color: var(--antsv-dark);">Nro. Serie Psicom√©trico: </span> <span class="text-muted">{{ eq['serial_psicom√©trico'] || eq.serial_psicometrico || 'N/A' }}</span></div>
                            <div><span class="fw-bold" style="color: var(--antsv-dark);">Nro. Serie Sensom√©trico: </span> <span class="text-muted">{{ eq['serial_sensom√©trico'] || eq.serial_sensometrico || 'N/A' }}</span></div>
                          </div>
                        </td>
                        <td class="text-center">
                          <span class="badge" :class="{'bg-success': eq.estado_homologacion === 'Homologado', 'bg-danger': eq.estado_homologacion === 'No Homologado'}"><i class="me-1" :class="{'bi-check-circle': eq.estado_homologacion === 'Homologado', 'bi-x-circle': eq.estado_homologacion === 'No Homologado'}"></i>{{ eq.estado_homologacion }}</span>
                        </td>
                        
                        <td class="text-center" v-if="esEditor('Equipos')">
                          <button class="btn btn-sm btn-outline-primary me-1" @click="openEquipoForm(eq)" title="Editar"><i class="bi bi-pencil-square"></i></button>
                          <button class="btn btn-sm btn-outline-danger" @click="deleteEquipo(eq.id_registro)" title="Eliminar"><i class="bi bi-trash3"></i></button>
                        </td>
                      </tr>
                      
                      <tr v-if="filteredEquipos.length === 0">
                        <td :colspan="esEditor('Equipos') ? 6 : 5" class="text-center p-5 text-muted">
                          <i class="bi bi-search display-6 d-block mb-3 opacity-50"></i>No se encontraron equipos.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        <div v-if="currentView === 'UBICACIONES'" class="card shadow-sm border-0">
          <div class="card-header d-flex justify-content-between align-items-center p-3">
            <h5 class="mb-0"><i class="bi bi-pin-map me-2"></i>Historial de Ubicaciones</h5>
            <button class="btn btn-primary btn-sm" @click="openUbiForm()" v-if="!showUbiForm && esEditor('Ubicaciones')">
              <i class="bi bi-geo-fill me-1"></i> Asignar Nueva Ubicaci√≥n
            </button>
          </div>
          
          <div class="card-body">
            <div v-if="showUbiForm" class="p-4 rounded mb-4 shadow-sm border" style="background-color: #f8f9fa;">
              <h5 class="mb-4 fw-bold text-primary border-bottom pb-2">
                <i class="bi bi-truck me-2"></i>Registrar Movimiento de Equipo
              </h5>
              
              <div class="row g-4">
                <div class="col-12">
                  <label class="form-label fw-bold text-dark">1. Seleccione el Equipo <span class="text-danger">*</span></label>
                  <select class="form-select form-select-lg border-primary shadow-sm" v-model="formUbi.id_equipo">
                    <option value="" disabled>Elegir equipo de la lista...</option>
                    <option v-for="eq in db.equipos" :key="eq.id_registro" :value="eq.id_registro">
                      {{ eq.id_registro }} - {{ eq.marca }} ({{ getEmpresaNombre(eq.id_empresa) }})
                    </option>
                  </select>
                </div>

                <div class="col-12" v-if="formUbi.id_equipo">
                  <div class="card bg-white border-warning shadow-sm">
                    <div class="card-header bg-warning bg-opacity-10 py-2">
                      <small class="fw-bold text-warning-emphasis text-uppercase"><i class="bi bi-geo-alt me-1"></i> Ubicaci√≥n Actual (Origen)</small>
                    </div>
                    <div class="card-body py-3">
                      <div class="row" v-if="ubicacionActualSeleccionada">
                        <div class="col-md-3">
                          <small class="text-muted d-block">Departamento / Distrito</small>
                          <span class="fw-bold">{{ ubicacionActualSeleccionada.departamento }}</span><br>
                          <span class="small">{{ ubicacionActualSeleccionada.distrito }}</span>
                        </div>
                        <div class="col-md-3 border-start">
                          <small class="text-muted d-block">Nivel</small>
                          <span class="badge bg-secondary">{{ ubicacionActualSeleccionada.competencia }}</span>
                        </div>
                        <div class="col-md-6 border-start">
                          <small class="text-muted d-block">Lugar Espec√≠fico</small>
                          <i class="bi bi-info-circle me-1 text-muted"></i>{{ ubicacionActualSeleccionada.lugar_especifico }}
                        </div>
                      </div>
                      <div v-else class="text-center py-2 text-muted">
                        <i class="bi bi-exclamation-triangle me-2"></i>Este equipo no tiene una ubicaci√≥n activa registrada.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12" v-if="formUbi.id_equipo">
                  <div class="card bg-white border-success shadow-sm">
                    <div class="card-header bg-success bg-opacity-10 py-2">
                      <small class="fw-bold text-success text-uppercase"><i class="bi bi-geo-fill me-1"></i> Nueva Ubicaci√≥n de Destino</small>
                    </div>
                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Nuevo Departamento <span class="text-danger">*</span></label>
                          <select class="form-select" v-model="formUbi.departamento">
                            <option value="">Seleccione...</option>
                            <option v-for="d in deptosList" :key="d.valor" :value="d.valor">{{ d.valor }}</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Nuevo Distrito <span class="text-danger">*</span></label>
                          <select class="form-select" v-model="formUbi.distrito" :disabled="!formUbi.departamento">
                            <option value="">Seleccione Distrito...</option>
                            <option v-for="dis in distritosFiltrados" :key="dis.valor" :value="dis.valor">{{ dis.valor }}</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Nuevo Nivel de Competencia</label>
                          <select class="form-select" v-model="formUbi.competencia">
                            <option value="Municipal">Municipal</option>
                            <option value="Distrital">Distrital</option>
                            <option value="Departamental">Departamental</option>
                            <option value="Nacional">Nacional</option>
                          </select>
                        </div>
                        <div class="col-md-12">
                          <label class="form-label small fw-bold">Nueva Direcci√≥n / Lugar Espec√≠fico <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" v-model="formUbi.lugar_especifico" placeholder="Ej: Cl√≠nica Central de la Municipalidad de...">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mt-4 d-flex justify-content-end gap-2">
                <button class="btn btn-outline-secondary px-4" @click="showUbiForm = false">Cancelar</button>
                <button class="btn btn-primary px-4 shadow" @click="submitUbi" :disabled="!isFormUbiValid">
                  <i class="bi bi-save me-2"></i>Confirmar Nuevo Traslado
                </button>
              </div>
            </div>

            <div v-show="!showUbiForm">
              <div class="row g-2 mb-3 p-3 rounded" style="background-color: var(--antsv-light); border: 1px solid rgba(36, 63, 92, 0.1);">
                <div class="col-md-3"><div class="input-group input-group-sm"><span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span><input type="text" class="form-control" v-model="searchUbi" placeholder="Buscar serial, marca, ciudad..."></div></div>
                <div class="col-md-3"><select class="form-select form-select-sm" v-model="filterEmpresaUbi"><option value="">üè¢ Todas las Empresas</option><option v-for="emp in db.empresas" :key="emp.id_empresa" :value="emp.id_empresa">{{ emp.razon_social }}</option></select></div>
                <div class="col-md-3"><select class="form-select form-select-sm" v-model="filterDepartamentoUbi"><option value="">üìç Todos los Departamentos</option><option v-for="d in deptosList" :key="d.valor" :value="d.valor">{{ d.valor }}</option></select></div>
                <div class="col-md-3"><select class="form-select form-select-sm" v-model="filterEstadoUbi"><option value="">üü¢/‚ö™ Todos los Estados</option><option value="Activo">üü¢ Solo Ubicaciones Activas</option><option value="Hist√≥rico">‚ö™ Solo Hist√≥rico Anterior</option></select></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle border shadow-sm">
                  <thead class="table-light">
                    <tr><th>Equipo / Marca</th><th>Ubicaci√≥n Geogr√°fica</th><th>Nivel / Direcci√≥n</th><th>Estado</th><th class="text-center">Acciones</th></tr>
                  </thead>
                  <tbody>
                    <tr v-for="u in filteredUbicaciones" :key="u.id_ubicacion" :class="{'table-info': u.estado_actual === 'Activo'}">
                      <td>
                        <div class="fw-bold" style="color: var(--antsv-dark); font-size: 1.1rem;"><i class="bi bi-cpu me-1"></i> {{ u.id_equipo }}</div>
                        <div class="mt-1" style="font-size: 0.85rem;">
                          <div class="mb-1"><span class="fw-bold text-uppercase" style="color: var(--antsv-dark); font-size: 0.75rem;">Marca:</span> <span class="text-muted">{{ getEquipoMarca(u.id_equipo) }}</span></div>
                          
                          <div>
                            <span class="fw-bold text-uppercase" style="color: var(--antsv-dark); font-size: 0.75rem;">Estado:</span> 
                            <span :class="getEquipoEstadoLegal(u.id_equipo) === 'Homologado' ? 'text-success fw-bold' : 'text-danger fw-bold'">
                              {{ getEquipoEstadoLegal(u.id_equipo) }}
                            </span>
                          </div>
                        </div>
                      </td>

                      <td>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-geo-alt-fill text-danger me-2 fs-5"></i>
                          <div><div class="fw-bold">{{ u.departamento }}</div><div class="small text-muted">{{ u.distrito }}</div></div>
                        </div>
                      </td>
                      <td><div class="badge mb-1" style="background-color: transparent; border: 1px solid var(--antsv-dark); color: var(--antsv-dark);">{{ u.competencia }}</div><div class="small">{{ u.lugar_especifico }}</div></td>

                      <td>
                        <div class="badge w-100 mb-1" :class="u.estado_actual === 'Activo' ? 'bg-primary' : 'bg-secondary'">
                          <i :class="u.estado_actual === 'Activo' ? 'bi bi-geo-fill' : 'bi bi-clock-history'" class="me-1"></i>{{ u.estado_actual }}
                        </div>
                        
                        <div v-if="u.estado_actual === 'Activo'" class="badge w-100" :class="getEquipoEstadoLegal(u.id_equipo) === 'Homologado' ? 'bg-success' : 'bg-danger'">
                          <i :class="getEquipoEstadoLegal(u.id_equipo) === 'Homologado' ? 'bi bi-shield-check' : 'bi bi-shield-x'" class="me-1"></i>
                          {{ getEquipoEstadoLegal(u.id_equipo) === 'Homologado' ? 'Vigente' : 'No Homologado' }}
                        </div>
                      </td>

                      <td class="text-center">
                        <button class="btn btn-sm btn-outline-secondary" @click="viewUbiDetails(u)" title="Ver Detalles"><i class="bi bi-eye"></i></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

          <div v-if="currentView === 'CONFIGURACION'" class="card shadow-sm border-0">
            <div class="card-header p-0" style="background-color: var(--antsv-dark); border-radius: 10px 10px 0 0;">
              <ul class="nav nav-tabs px-3 pt-3" style="border-bottom: none;">
                <li class="nav-item">
                  <a class="nav-link rounded-top" :class="{active: activeConfigTab === 'PARAMETROS', 'text-dark fw-bold': activeConfigTab === 'PARAMETROS', 'text-white': activeConfigTab !== 'PARAMETROS'}" href="#" @click.prevent="activeConfigTab = 'PARAMETROS'" style="border: none; border-bottom: 3px solid transparent;" :style="activeConfigTab === 'PARAMETROS' ? 'background-color: var(--antsv-white);' : ''">
                    <i class="bi bi-gear-fill me-1"></i> Par√°metros del Sistema
                  </a>
                </li>
                <li class="nav-item" v-if="role === 'ADMIN'">
                  <a class="nav-link rounded-top" :class="{active: activeConfigTab === 'USUARIOS', 'text-dark fw-bold': activeConfigTab === 'USUARIOS', 'text-white': activeConfigTab !== 'USUARIOS'}" href="#" @click.prevent="activeConfigTab = 'USUARIOS'" style="border: none; border-bottom: 3px solid transparent;" :style="activeConfigTab === 'USUARIOS' ? 'background-color: var(--antsv-white);' : ''">
                    <i class="bi bi-people-fill me-1"></i> Accesos y Usuarios
                  </a>
                </li>
              </ul>
            </div>

            <div class="card-body bg-light p-4">

              <div v-show="activeConfigTab === 'PARAMETROS'">
                <div class="d-flex justify-content-end mb-3">
                  <button class="btn btn-warning btn-sm fw-bold shadow-sm" @click="toggleEditConfig" v-if="!isEditingConfig"><i class="bi bi-pencil-square me-1"></i> Habilitar Edici√≥n</button>
                </div>
                <div class="alert alert-warning border-warning shadow-sm mb-4" v-if="isEditingConfig">
                  <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i> <strong>Modo Edici√≥n Activado:</strong> Modificar estos valores alterar√° el funcionamiento global.
                </div>

                <div class="card border-0 shadow-sm">
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 25%;"><i class="bi bi-key me-1"></i> Par√°metro (Clave)</th>
                          <th style="width: 45%;">Valor de Configuraci√≥n</th>
                          <th style="width: 30%;">Descripci√≥n / Efecto</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="item in (isEditingConfig ? formConfig : db.configuracion_raw)" :key="item.clave">
                          <td class="fw-bold" style="color: var(--antsv-dark); font-family: monospace;">{{ item.clave }}</td>
                          <td>
                            <div v-if="!isEditingConfig">
                              <span v-if="item.valor === 'True'" class="badge bg-success px-3 py-2"><i class="bi bi-toggle-on me-1"></i>Activado</span>
                              <span v-else-if="item.valor === 'False'" class="badge bg-danger px-3 py-2"><i class="bi bi-toggle-off me-1"></i>Desactivado</span>
                              <div v-else class="text-break bg-light border rounded p-2 small">{{ item.valor }}</div>
                            </div>
                            <div v-else>
                              <select v-if="item.valor === 'True' || item.valor === 'False'" class="form-select shadow-sm" v-model="item.valor">
                                <option value="True">Activado</option>
                                <option value="False">Desactivado</option>
                              </select>
                              <textarea v-else class="form-control shadow-sm" v-model="item.valor" rows="2"></textarea>
                            </div>
                          </td>
                          <td class="small text-muted border-start">{{ item.descripcion }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-4" v-if="isEditingConfig">
                  <button class="btn btn-outline-secondary px-4" @click="isEditingConfig = false"><i class="bi bi-x-circle me-1"></i> Cancelar</button>
                  <button class="btn btn-success px-4 fw-bold shadow" @click="submitConfig"><i class="bi bi-save me-1"></i> Guardar Cambios</button>
                </div>
              </div>

              <div v-show="activeConfigTab === 'USUARIOS'">
                <div v-if="!showUserForm">
                  <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-primary fw-bold shadow-sm" @click="openUserForm()"><i class="bi bi-person-plus-fill me-1"></i> Nuevo Usuario</button>
                  </div>
                  <div class="card border-0 shadow-sm table-responsive">
                    <table class="table table-hover align-middle text-center mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Avatar</th>
                          <th>Correo Gmail</th>
                          <th>Rol / Perfil</th>
                          <th>Estado</th>
                          <th>√öltimo Acceso</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="usr in db.usuarios" :key="usr.email">
                          <td>
                            <img v-if="usr.avatar" :src="usr.avatar" alt="avatar" class="rounded-circle border" style="width: 40px; height: 40px; object-fit: cover;">
                            <i v-else class="bi bi-person-circle fs-2 text-muted"></i>
                          </td>
                          <td class="fw-bold">{{ usr.email }}</td>
                          <td><span class="badge border text-dark" style="background-color: var(--antsv-light);">{{ usr.rol }}</span></td>
                          <td><span class="badge" :class="usr.estado === 'ACTIVO' ? 'bg-success' : 'bg-danger'">{{ usr.estado }}</span></td>
                          <td class="small text-muted">{{ usr.ultimo_acceso ? new Date(usr.ultimo_acceso).toLocaleString() : 'Nunca' }}</td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary me-1" @click="openUserForm(usr)" title="Editar Permisos"><i class="bi bi-key-fill"></i></button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteUser(usr.email)" title="Eliminar"><i class="bi bi-trash3"></i></button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div v-if="showUserForm" class="card shadow-sm border-0">
                  <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-bold" style="color: var(--antsv-dark);"><i class="bi bi-person-badge me-2 text-primary"></i>{{ isEditingUser ? 'Editar Permisos de: ' + formUser.email : 'Nuevo Perfil de Acceso' }}</h5>
                  </div>
                  <div class="card-body p-4">
                    <div class="row g-4">

                      <div class="col-md-5 border-end">
                        <h6 class="fw-bold mb-3 text-muted"><i class="bi bi-info-circle me-1"></i> Datos Principales</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold small">Cuenta de Google (Email) <span class="text-danger">*</span></label>
                          <input type="email" class="form-control" v-model="formUser.email" :disabled="isEditingUser" placeholder="ejemplo@antsv.gov.py">
                        </div>

                        <div class="row g-2 mb-3">
                          <div class="col-6">
                            <label class="form-label fw-bold small">Rol L√≥gico</label>
                            <select class="form-select" v-model="formUser.rol">
                              <option value="Admin">Administrador</option>
                              <option value="Operador">Operador</option>
                            </select>
                          </div>
                          <div class="col-6">
                            <label class="form-label fw-bold small">Estado</label>
                            <select class="form-select" v-model="formUser.estado">
                              <option value="ACTIVO">Activo</option>
                              <option value="INACTIVO">Inactivo / Bloqueado</option>
                            </select>
                          </div>
                        </div>

                        <div class="mb-3">
                          <label class="form-label fw-bold small">Avatar / Foto de Perfil</label>
                          <div class="d-flex align-items-center gap-2">
                            <img v-if="formUser.avatar" :src="formUser.avatar" class="rounded-circle border" style="width: 45px; height: 45px;">
                            <i v-else class="bi bi-person-circle fs-1 text-muted"></i>
                            <input type="text" class="form-control form-control-sm" v-model="formUser.avatar" placeholder="URL de la imagen...">
                            <button class="btn btn-outline-secondary btn-sm" @click="generateAvatar" title="Generar Autom√°tico"><i class="bi bi-magic"></i></button>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-7">
                        <h6 class="fw-bold mb-3 text-muted"><i class="bi bi-shield-lock me-1"></i> Matriz de Accesos por M√≥dulo</h6>
                        <div class="table-responsive border rounded bg-white">
                          <table class="table table-sm table-hover align-middle mb-0">
                            <thead class="table-light">
                              <tr>
                                <th>M√≥dulo del Sistema</th>
                                <th class="text-center">Nivel de Acceso Otorgado</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="mod in modulosDisponibles" :key="mod">
                                <td class="fw-bold text-muted px-3"><i class="bi bi-folder2-open me-2"></i>{{ mod }}</td>
                                <td class="text-center p-2">
                                  <select class="form-select form-select-sm shadow-sm border-0 bg-light" v-model="formUser.permisos[mod]" :class="{'text-success fw-bold': formUser.permisos[mod]==='Editor', 'text-primary fw-bold': formUser.permisos[mod]==='Lector', 'text-danger': formUser.permisos[mod]==='Ninguno'}">
                                    <option value="Ninguno">‚ùå Sin Acceso</option>
                                    <option value="Lector">üëÅÔ∏è Lector (Solo Ver)</option>
                                    <option value="Editor">‚úçÔ∏è Editor (Crear/Modificar)</option>
                                  </select>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="alert alert-info mt-3 small py-2"><i class="bi bi-info-circle-fill me-1"></i><strong>Nota:</strong> Los usuarios "Admin" ignoran estas restricciones y tienen control total.</div>
                      </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                      <button class="btn btn-outline-secondary px-4" @click="showUserForm = false"><i class="bi bi-x-circle me-1"></i> Cancelar</button>
                      <button class="btn btn-primary px-4 fw-bold shadow" @click="submitUser" :disabled="!isFormUserValid"><i class="bi bi-check-circle me-1"></i> Guardar Credenciales</button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

      </div>

      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
      setup() {
        // =====================================
        // ESTADO GLOBAL
        // =====================================
        const logoANTSV = ref("");
        const isLoading = ref(true); 
        const isRefreshing = ref(false); 
        const loadingMessage = ref("Inicializando Entorno Seguro...");
        const role = ref("");
        const currentUser = ref("");
        const db = ref({ equipos: [], ubicaciones: [], resoluciones: [], empresas: [], usuarios: [] });
        const config = ref({});
        const currentView = ref("DASHBOARD");
        const isMobileMenuOpen = ref(false);

        // =====================================
        // COMUNICACI√ìN CON BACKEND
        // =====================================
        const loadInitialData = () => {
          isLoading.value = true;
          google.script.run
            .withSuccessHandler((responseStr) => {
              if (!responseStr) { Swal.fire('Error del Servidor', 'Google Apps Script no devolvi√≥ datos.', 'error'); isLoading.value = false; return; }
              const response = JSON.parse(responseStr);
              role.value = response.role; 
              currentUser.value = response.user; 
              db.value = response.data;
              config.value = response.data.configuracion || {}; 
              logoANTSV.value = response.data.logoBase64;
              isLoading.value = false;
            })
            .withFailureHandler((error) => { Swal.fire('Error Critico', error.message, 'error'); isLoading.value = false; })
            .getInitialPayload();
        };

        const refreshDataSilent = () => {
          isRefreshing.value = true;
          google.script.run
            .withSuccessHandler((responseStr) => {
              if (responseStr) {
                const response = JSON.parse(responseStr);
                db.value = response.data; 
              }
              isRefreshing.value = false;
            })
            .withFailureHandler(() => { isRefreshing.value = false; }) 
            .getInitialPayload();
        };

        const navigate = (view) => {
          currentView.value = view;
          isMobileMenuOpen.value = false;
          refreshDataSilent(); 
        };

        // =====================================
        // M√ìDULO CONFIGURACI√ìN Y USUARIOS
        // =====================================
        const activeConfigTab = ref('PARAMETROS'); 
        const isEditingConfig = ref(false);
        const formConfig = ref([]);

        const toggleEditConfig = () => {
          formConfig.value = JSON.parse(JSON.stringify(db.value.configuracion_raw || []));
          isEditingConfig.value = true;
        };

        const submitConfig = () => {
          Swal.fire({ title: '¬øGuardar Configuraciones?', text: "Afectar√° a toda la aplicaci√≥n.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#84B74C' }).then((result) => {
            if (result.isConfirmed) {
              isLoading.value = true; loadingMessage.value = "Aplicando configuraciones...";
              google.script.run
                .withSuccessHandler(() => { isLoading.value = false; Swal.fire('√âxito', 'Configuraci√≥n actualizada.', 'success'); isEditingConfig.value = false; refreshDataSilent(); })
                .withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
                .saveConfigTransaction(formConfig.value);
            }
          });
        };

        const showUserForm = ref(false);
        const isEditingUser = ref(false);
        const modulosDisponibles = ['Empresas', 'Equipos', 'Ubicaciones', 'Resoluciones', 'Configuracion'];
        
        const formUser = ref({ 
          email: "", rol: "Operador", estado: "ACTIVO", avatar: "", ultimo_acceso: "", isUpdate: false,
          permisos: { Empresas: "Ninguno", Equipos: "Ninguno", Ubicaciones: "Ninguno", Resoluciones: "Ninguno", Configuracion: "Ninguno" }
        });

        const isFormUserValid = computed(() => formUser.value.email.includes('@') && formUser.value.rol);

        const generateAvatar = () => {
          if (!formUser.value.email) return;
          formUser.value.avatar = 'https://api.dicebear.com/7.x/identicon/svg?seed=' + formUser.value.email;
        };

        const openUserForm = (user = null) => {
          if (user) {
            let parsedPermisos = {};
            try { parsedPermisos = JSON.parse(user.permisos); } catch(e) {} 
            
            isEditingUser.value = true;
            formUser.value = { 
              email: user.email, rol: user.rol, estado: user.estado, avatar: user.avatar || "", ultimo_acceso: user.ultimo_acceso, isUpdate: true,
              permisos: {
                Empresas: parsedPermisos.Empresas || (parsedPermisos.roles && parsedPermisos.roles.includes('Todos') ? 'Editor' : 'Ninguno'),
                Equipos: parsedPermisos.Equipos || (parsedPermisos.roles && parsedPermisos.roles.includes('Todos') ? 'Editor' : 'Ninguno'),
                Ubicaciones: parsedPermisos.Ubicaciones || (parsedPermisos.roles && parsedPermisos.roles.includes('Todos') ? 'Editor' : 'Ninguno'),
                Resoluciones: parsedPermisos.Resoluciones || (parsedPermisos.roles && parsedPermisos.roles.includes('Todos') ? 'Editor' : 'Ninguno'),
                Configuracion: parsedPermisos.Configuracion || (parsedPermisos.roles && parsedPermisos.roles.includes('Todos') ? 'Editor' : 'Ninguno')
              }
            };
          } else {
            isEditingUser.value = false;
            formUser.value = { 
              email: "", rol: "Operador", estado: "ACTIVO", avatar: "", ultimo_acceso: "", isUpdate: false,
              permisos: { Empresas: "Ninguno", Equipos: "Ninguno", Ubicaciones: "Ninguno", Resoluciones: "Ninguno", Configuracion: "Ninguno" }
            };
          }
          showUserForm.value = true;
        };

        const submitUser = () => {
          isLoading.value = true; loadingMessage.value = "Guardando credenciales...";
          google.script.run
            .withSuccessHandler(() => { 
              isLoading.value = false;
              Swal.fire('√âxito', 'Usuario guardado.', 'success'); 
              showUserForm.value = false; 
              refreshDataSilent(); 
            })
            .withFailureHandler(err => { 
              isLoading.value = false; 
              Swal.fire('Error', err.message, 'error'); 
            })
            .saveUsuarioTransaction(formUser.value);
        };

        const deleteUser = (email) => {
          Swal.fire({ title: '¬øEliminar Usuario?', text: email, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, Eliminar' }).then((result) => {
            if (result.isConfirmed) {
              isLoading.value = true; loadingMessage.value = "Borrando acceso...";
              google.script.run
                .withSuccessHandler(() => { Swal.fire('Eliminado', 'Usuario revocado.', 'success'); refreshDataSilent(); })
                .withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
                .deleteUsuarioTransaction(email);
            }
          });
        };

      // =====================================
      // M√ìDULO RESOLUCIONES
      // =====================================
      const isEditingRes = ref(false);
      const formRes = ref({
        id_original: "", 
        numero: "", 
        anio: new Date().getFullYear(), 
        fecha_emision: "", // Nuevo
        vencimiento: "",     // Nuevo
        id_equipo: [], 
        tipo_acto: "1-Homologaci√≥n", 
        afecta: "", 
        fileBase64: null, 
        fileName: "", 
        mimeType: "", 
        incluir_ubicaciones: false, 
        ubicaciones_equipos: {} 
      });

      watch(() => formRes.value.id_equipo, (newEquipos) => {
        newEquipos.forEach(eqId => {
          // Si el equipo seleccionado no tiene a√∫n su objeto de ubicaci√≥n, lo creamos
          if (!formRes.value.ubicaciones_equipos[eqId]) {
            formRes.value.ubicaciones_equipos[eqId] = { 
              departamento: "", 
              distrito: "", 
              competencia: "Distrital", 
              lugar_especifico: "" 
            };
          }
        });
      }, { deep: true });

      const groupedResoluciones = computed(() => {
        if (!db.value.resoluciones) return [];
        const map = new Map();
        db.value.resoluciones.forEach(r => {
          if (!r) return;
          if (!map.has(r.id_resolucion)) {
            map.set(r.id_resolucion, { 
              id_resolucion: r.id_resolucion, tipo_acto: r.tipo_acto, afecta: r.afecta, 
              fecha_emision: r.fecha_emision, vencimiento: r.vencimiento, estado: r.estado, url_drive: r.url_drive, equipos: [] 
            });
          }
          if (r.id_equipo_vinculado && !map.get(r.id_resolucion).equipos.includes(r.id_equipo_vinculado)) {
            map.get(r.id_resolucion).equipos.push(r.id_equipo_vinculado);
          }
        });
        return Array.from(map.values());
      });

      const resolucionesMadreList = computed(() => {
        if (formRes.value.tipo_acto === "2-Renovaci√≥n") return groupedResoluciones.value; 
        else if (formRes.value.tipo_acto === "3-Cambio Ubicaci√≥n") return groupedResoluciones.value.filter(r => r.estado === "Vigente"); 
        return [];
      });

      watch(() => formRes.value.tipo_acto, (newTipo) => { if (newTipo === "1-Homologaci√≥n") formRes.value.afecta = ""; });

      const getDistritosPorDepto = (depto) => {
        if (!depto) return [];
        const match = depto.match(/\[PY-\d+\]/);
        return db.value.catalogos.filter(c => c.categoria === 'DISTRITO' && c.padre_id.includes(match ? match[0] : ""));
      };

      const isFormResValid = computed(() => {
        const hasBaseData = formRes.value.numero && formRes.value.anio && formRes.value.id_equipo.length > 0;
        const hasPdfOrIsEdit = isEditingRes.value || formRes.value.fileBase64;
        const vinculadaValid = formRes.value.tipo_acto === "1-Homologaci√≥n" || formRes.value.afecta !== "";
        let ubiValid = true;
        if (formRes.value.incluir_ubicaciones) {
          ubiValid = formRes.value.id_equipo.every(eqId => {
            const ubi = formRes.value.ubicaciones_equipos[eqId];
            return ubi && ubi.departamento && ubi.distrito && ubi.lugar_especifico;
          });
        }
        return hasBaseData && hasPdfOrIsEdit && vinculadaValid && ubiValid;
      });

      const openEditRes = (res) => {
        isEditingRes.value = true;
        const partes = res.id_resolucion.split('/');
        const num = partes[0] ? partes[0].replace(/\D/g, '') : '';
        const equiposVinculados = db.value.resoluciones.filter(r => r.id_resolucion === res.id_resolucion).map(r => r.id_equipo_vinculado);
        formRes.value = {
          id_original: res.id_resolucion, numero: num, anio: partes[1] || new Date().getFullYear(), id_equipo: equiposVinculados, 
          tipo_acto: res.tipo_acto, afecta: res.afecta || "", fileBase64: null, fileName: "", mimeType: "", incluir_ubicaciones: false, ubicaciones_equipos: {}
        };
        activeResTab.value = 'NUEVA'; 
      };

      const resolucionFormateada = computed(() => 'ANTSV N¬∞ ' + formRes.value.numero + '_' + formRes.value.anio);
      const triggerFileInput = () => document.getElementById('pdfUploader').click();
      
      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > (config.value.MAX_FILE_SIZE_MB || 5) * 1024 * 1024) return Swal.fire('Archivo muy pesado', 'Excede el l√≠mite.', 'warning');
        formRes.value.fileName = file.name; formRes.value.mimeType = file.type;
        const reader = new FileReader();
        reader.onload = (e) => formRes.value.fileBase64 = e.target.result.split(',')[1]; 
        reader.readAsDataURL(file);
      };

      const submitResolucion = () => {
        Swal.fire({
          title: isEditingRes.value ? '¬øActualizar Resoluci√≥n?' : '¬øConfirmar Registro?', text: 'Se afectar√° a ' + formRes.value.id_equipo.length + ' equipo(s).',
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#84B74C', confirmButtonText: 'S√≠, Proceder', cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            isLoading.value = true; loadingMessage.value = isEditingRes.value ? "Actualizando datos..." : "Registrando tr√°mite y controlando tiempos...";
            const payloadData = {
              id_original: formRes.value.id_original, id_nuevo: resolucionFormateada.value, id_resolucion: resolucionFormateada.value,
              id_equipo: formRes.value.id_equipo, tipo_acto: formRes.value.tipo_acto, afecta: formRes.value.afecta,
              ubicaciones_equipos: formRes.value.incluir_ubicaciones ? formRes.value.ubicaciones_equipos : null 
            };
            if (isEditingRes.value) {
              google.script.run
                .withSuccessHandler(() => {
                  isLoading.value = false; Swal.fire('√âxito', 'Resoluci√≥n actualizada.', 'success');
                  formRes.value = { id_original: "", numero: "", anio: new Date().getFullYear(), id_equipo: [], tipo_acto: "1-Homologaci√≥n", afecta: "", fileBase64: null, fileName: "", mimeType: "", incluir_ubicaciones: false, ubicaciones_equipos: {} };
                  isEditingRes.value = false; activeResTab.value = "LISTADO"; refreshDataSilent(); 
                }).withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
                .updateResolucionTransaction(payloadData);
            } else {
              const payloadFile = { 
                base64: formRes.value.fileBase64, 
                nombre: resolucionFormateada.value + ".pdf", // Resultado: ANTSV N¬∞ 670_2023.pdf
                mimeType: formRes.value.mimeType 
              };
              google.script.run
                .withSuccessHandler(() => {
                  isLoading.value = false; Swal.fire('√âxito', 'Tr√°mite legal registrado y equipos actualizados.', 'success');
                  formRes.value = { id_original: "", numero: "", anio: new Date().getFullYear(), id_equipo: [], tipo_acto: "1-Homologaci√≥n", afecta: "", fileBase64: null, fileName: "", mimeType: "", incluir_ubicaciones: false, ubicaciones_equipos: {} };
                  activeResTab.value = "LISTADO"; refreshDataSilent(); 
                }).withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
                .processResolutionUpload(payloadFile, payloadData);
            }
          }
        });
      };

      const activeResTab = ref("LISTADO");
      const searchRes = ref("");
      const filterTipoActoRes = ref("");
      const filterEstadoRes = ref("Vigente");

      const filteredResoluciones = computed(() => {
        let result = groupedResoluciones.value;
        if (filterEstadoRes.value) result = result.filter(r => r.estado === filterEstadoRes.value);
        if (filterTipoActoRes.value) result = result.filter(r => r.tipo_acto === filterTipoActoRes.value);
        if (searchRes.value) {
          const q = searchRes.value.toLowerCase();
          result = result.filter(r => r.id_resolucion.toLowerCase().includes(q) || r.equipos.some(eqId => eqId.toLowerCase().includes(q) || getEquipoMarca(eqId).toLowerCase().includes(q)));
        }
        return result;
      });

      // Funci√≥n para obtener el estado de homologaci√≥n real desde la tabla de EQUIPOS
        const getEquipoEstadoLegal = (id_equipo) => {
          const eq = (db.value.equipos || []).find(e => String(e.id_registro).trim() === String(id_equipo).trim());
          return eq ? eq.estado_homologacion : 'Sin Datos';
        };

      const estadosResolucionList = computed(() => db.value.catalogos ? db.value.catalogos.filter(c => c.categoria === 'ESTADO_RESOLUCION') : []);

        // =====================================
        // M√ìDULO EMPRESAS
        // =====================================
        const showEmpresaForm = ref(false);
        const isEditingEmp = ref(false);
        const formEmp = ref({ id_empresa: "", razon_social: "", ruc: "", representante: "", email: "", direccion: "", tipo_entidad: "Fabricante de Equipos", actividad_principal: "", isUpdate: false });
        const isFormEmpValid = computed(() => formEmp.value.id_empresa && formEmp.value.razon_social && formEmp.value.ruc);

        const openEmpresaForm = (empresa = null) => {
          if (empresa) { isEditingEmp.value = true; formEmp.value = { ...empresa, isUpdate: true }; } 
          else { isEditingEmp.value = false; formEmp.value = { id_empresa: "", razon_social: "", ruc: "", representante: "", email: "", direccion: "", tipo_entidad: "Fabricante de Equipos", actividad_principal: "", isUpdate: false }; }
          showEmpresaForm.value = true;
        };

        const submitEmpresa = () => {
          isLoading.value = true; loadingMessage.value = "Guardando empresa...";
          google.script.run
            .withSuccessHandler(() => { Swal.fire('√âxito', 'Empresa guardada.', 'success'); showEmpresaForm.value = false; refreshDataSilent(); })
            .withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
            .saveEmpresaTransaction(formEmp.value);
        };

        const deleteEmpresa = (id_empresa, razon_social) => {
          Swal.fire({ title: '¬øEliminar Empresa?', html: 'Borrar√° a <b>' + razon_social + '</b>.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, Eliminar' }).then((result) => {
            if (result.isConfirmed) {
              isLoading.value = true; loadingMessage.value = "Eliminando...";
              google.script.run
                .withSuccessHandler(() => { Swal.fire('Eliminada', 'Empresa dada de baja.', 'success'); refreshDataSilent(); })
                .withFailureHandler(err => { isLoading.value = false; Swal.fire('Acci√≥n Bloqueada', err.message, 'error'); })
                .deleteEmpresaTransaction(id_empresa);
            }
          });
        };

        // =====================================
        // M√ìDULO EQUIPOS
        // =====================================
        const showEquipoForm = ref(false);
        const isEditingEq = ref(false);
        const formEq = ref({ id_registro: "", id_empresa: "", descripcion: "", marca: "", serial_psicometrico: "", serial_sensometrico: "", estado_homologacion: "", isUpdate: false });
        
        const isFormEqValid = computed(() => {
          const isValid = formEq.value.id_empresa && formEq.value.marca && formEq.value.serial_psicometrico && formEq.value.serial_sensometrico;
          return isEditingEq.value ? (isValid && formEq.value.id_registro) : isValid;
        });

        const getEmpresaNombre = (id_empresa) => { const emp = db.value.empresas.find(e => e.id_empresa === id_empresa); return emp ? emp.razon_social : id_empresa; };
        const getEquipoMarca = (id_equipo) => { const eq = db.value.equipos.find(e => e.id_registro === id_equipo); return eq ? eq.marca : 'No identificado'; };

        const openEquipoForm = (equipo = null) => {
          if (equipo) {
            isEditingEq.value = true;
            formEq.value = { id_registro: equipo.id_registro, id_empresa: equipo.id_empresa, descripcion: equipo.descripcion, marca: equipo.marca, serial_psicometrico: equipo.serial_psicometrico || equipo['serial_psicom√©trico'], serial_sensometrico: equipo.serial_sensometrico || equipo['serial_sensom√©trico'], estado_homologacion: equipo.estado_homologacion || "", isUpdate: true };
          } else {
            isEditingEq.value = false;
            formEq.value = { id_registro: "", id_empresa: "", descripcion: "", marca: "", serial_psicometrico: "", serial_sensometrico: "", estado_homologacion: "", isUpdate: false };
          }
          showEquipoForm.value = true;
        };

        const submitEquipo = () => {
          isLoading.value = true; loadingMessage.value = "Guardando Equipo...";
          google.script.run
            .withSuccessHandler(() => { Swal.fire('√âxito', 'Equipo registrado.', 'success'); showEquipoForm.value = false; refreshDataSilent(); })
            .withFailureHandler(err => { isLoading.value = false; Swal.fire('Error', err.message, 'error'); })
            .saveEquipoTransaction(formEq.value);
        };

        const deleteEquipo = (id_registro) => {
          Swal.fire({ title: '¬øEliminar Equipo?', html: 'Borrar√° <b>' + id_registro + '</b>.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, Eliminar' }).then((result) => {
            if (result.isConfirmed) {
              isLoading.value = true; loadingMessage.value = "Eliminando...";
              google.script.run
                .withSuccessHandler(() => { Swal.fire('Eliminado', 'Equipo borrado.', 'success'); refreshDataSilent(); })
                .withFailureHandler(err => { isLoading.value = false; Swal.fire('Acci√≥n Bloqueada', err.message, 'error'); })
                .deleteEquipoTransaction(id_registro);
            }
          });
        };

        const searchEq = ref(""); const filterEmpresaEq = ref(""); const filterEstadoEq = ref("");
        const estadosEquipoList = computed(() => db.value.catalogos ? db.value.catalogos.filter(c => c.categoria === 'ESTADO_EQUIPO') : []);

        const filteredEquipos = computed(() => {
          let result = db.value.equipos || [];
          if (filterEstadoEq.value) result = result.filter(e => e.estado_homologacion === filterEstadoEq.value);
          if (filterEmpresaEq.value) result = result.filter(e => e.id_empresa === filterEmpresaEq.value);
          if (searchEq.value) {
            const q = searchEq.value.toLowerCase();
            result = result.filter(e => e.id_registro.toLowerCase().includes(q) || e.marca.toLowerCase().includes(q) || getEmpresaNombre(e.id_empresa).toLowerCase().includes(q));
          }
          return result;
        });

        // =====================================
        // M√ìDULO UBICACIONES
        // =====================================
        const showUbiForm = ref(false);
        const formUbi = ref({ id_equipo: "", departamento: "", distrito: "", competencia: "Distrital", lugar_especifico: "", estado_actual: "Activo" });

        const deptosList = computed(() => db.value.catalogos ? db.value.catalogos.filter(c => c.categoria === 'DEPARTAMENTO') : []);
        const distritosFiltrados = computed(() => {
          if (!formUbi.value.departamento) return [];
          const match = formUbi.value.departamento.match(/\[PY-\d+\]/);
          return db.value.catalogos.filter(c => c.categoria === 'DISTRITO' && c.padre_id.includes(match ? match[0] : ""));
        });

        const isFormUbiValid = computed(() => formUbi.value.id_equipo && formUbi.value.departamento && formUbi.value.distrito && formUbi.value.lugar_especifico);
        const openUbiForm = () => { formUbi.value = { id_equipo: "", departamento: "", distrito: "", competencia: "Distrital", lugar_especifico: "", estado_actual: "Activo" }; showUbiForm.value = true; };
        
        const getEquipoEmpresa = (id_equipo) => { const eq = db.value.equipos.find(e => e.id_registro === id_equipo); return eq ? getEmpresaNombre(eq.id_empresa) : 'No identificada'; };
        
        const getEquipoUbicacion = (id_equipo) => {
          if (!db.value.ubicaciones) return 'Sin historial';
          const ubi = db.value.ubicaciones.find(u => u.id_equipo === id_equipo && u.estado_actual === 'Activo');
          return ubi ? `${ubi.distrito}, ${ubi.departamento}` : 'Sin ubicaci√≥n activa';
        };

        const viewUbiDetails = (u) => {
          // Si tiene fecha de cierre, preparamos el texto, si no, ponemos "En curso"
          const cierreInfo = u.fecha_cierre ? `<b>Fecha de Cierre:</b> ${u.fecha_cierre}` : `<b>Fecha de Cierre:</b> <span class="text-success">Vigente / En curso</span>`;

          Swal.fire({
            title: '<i class="bi bi-info-square-fill text-primary"></i> Detalles del Registro',
            html: `
              <div class="text-start mt-3" style="font-size: 0.95rem;">
                <p><b>Equipo:</b> ${u.id_equipo} (${getEquipoMarca(u.id_equipo)})</p>
                <p><b>Ubicaci√≥n:</b> ${u.distrito}, ${u.departamento}</p>
                <p><b>Direcci√≥n:</b> ${u.lugar_especifico}</p>
                <p><b>Nivel:</b> ${u.competencia}</p>
                <hr>
                <p><b>Estado Hist√≥rico:</b> <span class="badge ${u.estado_actual === 'Activo' ? 'bg-success' : 'bg-secondary'}">${u.estado_actual}</span></p>
                <p>${cierreInfo}</p>
              </div>`,
            confirmButtonColor: '#243F5C'
          });
        };

        const submitUbi = () => {
          // VALIDACI√ìN DE DUPLICADOS:
          if (ubicacionActualSeleccionada.value) {
            const uAct = ubicacionActualSeleccionada.value;
            const uNew = formUbi.value;

            const esMismaUbicacion = 
              String(uAct.departamento).trim() === String(uNew.departamento).trim() &&
              String(uAct.distrito).trim() === String(uNew.distrito).trim() &&
              String(uAct.lugar_especifico).trim() === String(uNew.lugar_especifico).trim();

            if (esMismaUbicacion) {
              Swal.fire({
                title: 'Ubicaci√≥n Identica',
                text: 'El equipo ya se encuentra registrado en esa ubicaci√≥n exacta. No es necesario realizar el movimiento.',
                icon: 'info',
                confirmButtonColor: '#243F5C'
              });
              return; // Detiene la ejecuci√≥n
            }
          }

          // Si pasa la validaci√≥n, procede con el guardado normal
          isLoading.value = true;
          loadingMessage.value = "Actualizando ubicaci√≥n...";
          google.script.run
            .withSuccessHandler(() => { 
              isLoading.value = false;
              Swal.fire('√âxito', 'Ubicaci√≥n establecida correctamente.', 'success'); 
              showUbiForm.value = false; 
              refreshDataSilent(); 
            })
            .withFailureHandler(err => {
              isLoading.value = false;
              Swal.fire('Error', err.message, 'error');
            })
            .saveUbicacionTransaction(formUbi.value);
        };

        const searchUbi = ref(""); const filterEmpresaUbi = ref(""); const filterDepartamentoUbi = ref(""); const filterEstadoUbi = ref("Activo"); 

        const filteredUbicaciones = computed(() => {
          let result = db.value.ubicaciones || [];
          if (filterEstadoUbi.value) result = result.filter(u => u.estado_actual === filterEstadoUbi.value);
          if (filterDepartamentoUbi.value) result = result.filter(u => u.departamento === filterDepartamentoUbi.value);
          if (filterEmpresaUbi.value) result = result.filter(u => { const eq = db.value.equipos.find(e => e.id_registro === u.id_equipo); return eq && eq.id_empresa === filterEmpresaUbi.value; });
          if (searchUbi.value) {
            const q = searchUbi.value.toLowerCase();
            result = result.filter(u => u.id_equipo.toLowerCase().includes(q) || u.distrito.toLowerCase().includes(q) || u.lugar_especifico.toLowerCase().includes(q) || getEquipoMarca(u.id_equipo).toLowerCase().includes(q));
          }
          return result;
        });

        // Obtiene el objeto completo de la ubicaci√≥n activa para el equipo elegido en el formulario
        const ubicacionActualSeleccionada = computed(() => {
          if (!formUbi.value.id_equipo || !db.value.ubicaciones) return null;
          return db.value.ubicaciones.find(u => 
            String(u.id_equipo).trim() === String(formUbi.value.id_equipo).trim() && 
            u.estado_actual === 'Activo'
          );
        });

        onMounted(() => loadInitialData());

        // =====================================
        // CONTROL DE ACCESOS (PERMISOS GRANULARES)
        // =====================================
        const tienePermiso = (modulo) => {
          // 1. Los Administradores siempre tienen acceso a todo
          if (role.value === 'ADMIN' || role.value === 'Admin') return true;
          
          // 2. Buscar al usuario actual en la base de datos descargada
          if (!db.value.usuarios || db.value.usuarios.length === 0) return false;
          const user = db.value.usuarios.find(u => String(u.email).toLowerCase() === String(currentUser.value).toLowerCase());
          if (!user) return false;

          try {
            const permisos = JSON.parse(user.permisos);
            
            // 3. Compatibilidad con el formato viejo (Ej: {"roles": ["Todos"]} o {"roles": ["Empresas"]})
            if (permisos.roles && Array.isArray(permisos.roles)) {
              if (permisos.roles.includes('Todos')) return true;
              // La 'r' es por si en la BD qued√≥ guardado con error tipogr√°fico como 'Equiposr'
              if (permisos.roles.includes(modulo) || permisos.roles.includes(modulo + 'r')) return true; 
            }

            // 4. Evaluaci√≥n del formato nuevo y granular (Ej: {"Empresas": "Lector", "Equipos": "Ninguno"})
            if (permisos[modulo] === 'Editor' || permisos[modulo] === 'Lector') {
              return true;
            }
          } catch (e) {
            // Si el JSON en la base de datos est√° roto o vac√≠o, denegamos el acceso por seguridad
            return false; 
          }

          return false;
        };

        // =====================================
        // VERIFICADOR DE PERMISO DE ESCRITURA (NUEVO)
        // =====================================
        const esEditor = (modulo) => {
          if (role.value === 'ADMIN' || role.value === 'Admin') return true;
          
          if (!db.value.usuarios || db.value.usuarios.length === 0) return false;
          const user = db.value.usuarios.find(u => String(u.email).toLowerCase() === String(currentUser.value).toLowerCase());
          if (!user) return false;

          try {
            const permisos = JSON.parse(user.permisos);
            // Compatibilidad formato viejo
            if (permisos.roles && Array.isArray(permisos.roles) && permisos.roles.includes('Todos')) return true;
            
            // Validar si tiene expl√≠citamente el rol "Editor"
            return permisos[modulo] === 'Editor';
          } catch (e) {
            return false;
          }
        };

        // =====================================
        // OBJETO DE RETORNO FINAL
        // =====================================
        return {
          logoANTSV, isLoading, isRefreshing, loadingMessage, role, currentUser, db, config, currentView, isMobileMenuOpen, navigate,
          
          activeConfigTab, isEditingConfig, formConfig, toggleEditConfig, submitConfig, ubicacionActualSeleccionada, getEquipoEstadoLegal,

          showUserForm, isEditingUser, modulosDisponibles, formUser, isFormUserValid, generateAvatar, openUserForm, submitUser, deleteUser,
          
          formRes, isFormResValid, triggerFileInput, handleFileUpload, submitResolucion, activeResTab, searchRes, filterTipoActoRes, filterEstadoRes, groupedResoluciones, filteredResoluciones, estadosResolucionList, isEditingRes, openEditRes, getDistritosPorDepto, resolucionesMadreList,
          
          showEmpresaForm, isEditingEmp, formEmp, isFormEmpValid, openEmpresaForm, submitEmpresa, deleteEmpresa,
          
          showEquipoForm, isEditingEq, formEq, isFormEqValid, openEquipoForm, submitEquipo, deleteEquipo, getEmpresaNombre, getEquipoMarca, searchEq, filterEmpresaEq, filterEstadoEq, filteredEquipos, estadosEquipoList,
          
          showUbiForm, formUbi, deptosList, distritosFiltrados, isFormUbiValid, openUbiForm, submitUbi, getEquipoEmpresa, getEquipoUbicacion, searchUbi, filterEmpresaUbi, filterDepartamentoUbi, filterEstadoUbi, filteredUbicaciones, viewUbiDetails, tienePermiso, esEditor
        };
      }
    }).mount('#app');
  </script>
</body>
</html>